name: ðŸ§­ Go CI

on:
  # Run on PRs when Go files change
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "**/*.go"
      - "cmd/**"
      - "internal/**"
      - ".github/workflows/go-ci.yml"
      - "go.mod"
      - "go.sum"
  # Run on push to main to update coverage badges
  push:
    branches:
      - main
    paths:
      - "**/*.go"
      - "cmd/**"
      - "internal/**"
      - ".github/workflows/go-ci.yml"
      - "go.mod"
      - "go.sum"

permissions:
  contents: read
  pull-requests: write

env:
  GO_VERSION: "1.25"

jobs:
  lint:
    name: "ðŸ” Lint"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false # lint only runs gofmt â€” no modules needed

      - name: Run make lint-go
        run: make lint-go

  build:
    name: "ðŸ”¨ Build"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install system dependencies (libpcap)
        run: sudo apt-get update && sudo apt-get install -y libpcap-dev

      - name: Download Go modules
        run: go mod download

      - name: Build web stub for embed
        run: ./scripts/ensure-web-stub.sh

      - name: Build binaries
        run: |
          go build -tags=pcap -o velocity-report-local ./cmd/radar
          go build -o velocity-deploy ./cmd/deploy

  test-core:
    name: "ðŸ§ª Test Core"
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build web stub for embed
        run: ./scripts/ensure-web-stub.sh

      - name: Run core tests
        run: |
          go test -v -race -tags=pcap -coverprofile=coverage-core.out -covermode=atomic \
            ./internal/db/... \
            ./internal/radar/... \
            ./internal/serialmux/... \
            ./internal/security/... \
            ./internal/units/... \
            ./internal/timeutil/... \
            ./internal/httputil/... \
            ./internal/testutil/... \
            ./internal/fsutil/... \
            ./internal/monitoring/... \
            ./internal/deploy/... \
            ./cmd/deploy/...

      - name: Upload core coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-core
          path: coverage-core.out

  test-lidar:
    name: "ðŸ§ª Test LiDAR"
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Validate LFS files
        run: ./scripts/validate-lfs-files.sh

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install system dependencies (libpcap)
        run: sudo apt-get update && sudo apt-get install -y libpcap-dev

      - name: Build web stub for embed
        run: ./scripts/ensure-web-stub.sh

      - name: Run LiDAR tests
        run: |
          go test -v -race -tags=pcap -coverprofile=coverage-lidar.out -covermode=atomic \
            ./internal/lidar/...

      - name: Upload LiDAR coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lidar
          path: coverage-lidar.out

  test-integration:
    name: "ðŸ§ª Integration Tests"
    runs-on: ubuntu-latest
    needs: [test-core, test-lidar]
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Validate LFS files
        run: ./scripts/validate-lfs-files.sh

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install system dependencies (libpcap)
        run: sudo apt-get update && sudo apt-get install -y libpcap-dev

      - name: Install TeX Live for PDF generation tests
        run: |
          sudo apt-get install -y texlive-xetex texlive-fonts-recommended texlive-fonts-extra latexmk

      - name: Setup pnpm and build web
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate
          cd web
          pnpm install
          pnpm run build

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - name: Install Python dependencies
        run: make install-python

      - name: Run API tests (includes E2E with Python PDF generator)
        run: |
          go test -v -race -tags=pcap -coverprofile=coverage-api.out -covermode=atomic \
            ./internal/api/...

      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage-artifacts
          merge-multiple: true

      - name: Merge coverage profiles
        run: |
          # Combine coverage files from artifacts directory
          echo "mode: atomic" > coverage.out
          find coverage-artifacts -name "*.out" -type f | while read f; do
            if [ -f "$f" ]; then
              echo "Merging $f"
              tail -n +2 "$f" >> coverage.out
            fi
          done
          # Also check current directory for any direct files
          for f in coverage-*.out; do
            if [ -f "$f" ]; then
              echo "Merging $f"
              tail -n +2 "$f" >> coverage.out
            fi
          done
          echo "Combined coverage has $(wc -l < coverage.out) lines"

      - name: Upload Go coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.out
          flags: go
          name: go-coverage
          token: ${{ secrets.CODECOV_TOKEN }}
