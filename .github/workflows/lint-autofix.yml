name: ðŸ§¹ Weekly Auto-fix

on:
  schedule:
    # Cron format: minute hour day-of-month month day-of-week
    # Run every Monday at 6:00 AM UTC
    - cron: "0 6 * * 1"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  autofix:
    name: Auto-fix Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Python dependencies
        run: |
          python -m venv .venv
          .venv/bin/pip install --upgrade pip
          .venv/bin/pip install -r requirements.txt

      - name: Install web dependencies
        run: cd web && pnpm install --frozen-lockfile

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Step 1: Check and fix Python version consistency
      - name: Check Python version consistency
        id: python_version
        run: |
          echo "Checking Python version consistency..."
          if ! bash ./scripts/check-python-version.sh; then
            echo "needs_fix=true" >> $GITHUB_OUTPUT
            echo "Python version mismatches found"
          else
            echo "needs_fix=false" >> $GITHUB_OUTPUT
            echo "Python versions are consistent"
          fi

      - name: Fix Python version references
        if: steps.python_version.outputs.needs_fix == 'true'
        run: |
          echo "Fixing Python version references..."
          bash ./scripts/check-python-version.sh --fix
          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git commit -m "[ci][py] update Python version references for CI compatibility"
          fi

      # Step 2: Format Go code
      - name: Format Go code
        run: make format-go

      - name: Commit Go formatting
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git commit -m "[ci][go] auto-fix formatting (gofmt -s -w)"
          fi

      # Step 3: Format Python code
      - name: Format Python code
        run: make format-python

      - name: Commit Python formatting
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git commit -m "[ci][py] auto-fix formatting (black + ruff)"
          fi

      # Step 4: Format Web code
      - name: Format Web code
        run: make format-web

      - name: Commit Web formatting
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git commit -m "[ci][js] auto-fix formatting (prettier)"
          fi

      # Step 5: Create PR if any commits were made
      - name: Check for commits
        id: commits
        run: |
          if [[ $(git rev-list --count HEAD ^origin/main) -gt 0 ]]; then
            echo "has_commits=true" >> $GITHUB_OUTPUT
            echo "Created $(git rev-list --count HEAD ^origin/main) commit(s)"
          else
            echo "has_commits=false" >> $GITHUB_OUTPUT
            echo "No changes needed"
          fi

      - name: Create Pull Request
        if: steps.commits.outputs.has_commits == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "ðŸ§¹ Weekly formatting cleanup"
          body: |
            This PR was automatically created by the weekly lint auto-fix workflow.

            ## Changes
            This PR contains separate commits for each type of fix:
            1. **Python version updates** (if needed): Updated Python version references for GitHub Actions compatibility
            2. **Go formatting**: `make format-go` (gofmt -s -w)
            3. **Python formatting**: `make format-python` (black + ruff --fix)
            4. **Web formatting**: `make format-web` (prettier)

            ## Why this PR exists
            CI lint jobs are advisory (non-blocking) to reduce friction for contributors.
            This weekly cleanup ensures the codebase stays consistently formatted and version references stay synchronized with GitHub Actions runners.

            ---
            _This PR can be merged without review if CI passes._
          branch: ci/weekly-lint-autofix
          delete-branch: true
          labels: |
            automated
            formatting
