# M3.5 Track A: macOS Visualiser Split Streaming

## Overview

M3.5 Track A implements split streaming support in the macOS visualiser, enabling bandwidth reduction from ~80 Mbps to ~3 Mbps by caching background points client-side.

## Architecture

### Frame Types

The visualiser now supports four frame types:

| Type         | Value | Description                                   |
| ------------ | ----- | --------------------------------------------- |
| `full`       | 0     | Legacy: all points (backwards compatible)     |
| `foreground` | 1     | Foreground + clusters + tracks only           |
| `background` | 2     | Background snapshot for caching               |
| `delta`      | 3     | Future: incremental updates (not implemented) |

### Background Caching

The `CompositePointCloudRenderer` maintains two separate Metal buffers:

1. **Background Buffer**: Cached from background frames, reused across foreground frames
2. **Foreground Buffer**: Updated on every foreground frame

#### Cache States

- **Empty**: No background cached
- **Cached(seq)**: Background cached with sequence number
- **Refreshing**: Background update in progress

#### Sequence Validation

Each background snapshot has a `sequenceNumber` that increments on grid resets. Foreground frames reference the expected background sequence via `backgroundSeq`. If there's a mismatch, the cache is invalidated and the client should request a new background frame.

## Data Structures

### GridMetadata

```swift
struct GridMetadata {
    var rings: Int32 = 40
    var azimuthBins: Int32 = 1800
    var ringElevations: [Float] = []
    var settlingComplete: Bool = false
}
```

### BackgroundSnapshot

```swift
struct BackgroundSnapshot {
    var sequenceNumber: UInt64 = 0
    var timestampNanos: Int64 = 0
    var x: [Float] = []
    var y: [Float] = []
    var z: [Float] = []
    var confidence: [UInt32] = []  // TimesSeenCount per point
    var gridMetadata: GridMetadata?

    var pointCount: Int { x.count }
}
```

### FrameBundle Extensions

```swift
struct FrameBundle {
    // ... existing fields ...

    // M3.5 Split Streaming fields
    var frameType: FrameType = .full
    var background: BackgroundSnapshot?
    var backgroundSeq: UInt64 = 0
}
```

## UI Indicators

The visualiser displays cache status in the stats panel:

- **Green dot + "BG"**: Background cached (seq: N)
- **Orange dot + "BG"**: Background refreshing
- **Grey dot + "BG"**: Cache empty

## Performance Impact

### Before M3.5

- Full frames: ~65,000 points @ 10 Hz = ~80 Mbps

### After M3.5

- Background frame: ~50,000 points (sent once, cached)
- Foreground frames: ~2,000 points @ 10 Hz = ~3 Mbps
- **Total reduction: 96%**

## Testing

### Model Tests (`ModelM35Tests.swift`)

- FrameType enum values and conversions
- GridMetadata default and custom values
- BackgroundSnapshot point count consistency
- Sequence number tracking and validation
- Large point cloud handling (65k points)

### Renderer Tests (`CompositePointCloudRendererTests.swift`)

- Background caching and retrieval
- Foreground processing
- Cache sequence validation
- Cache invalidation on sequence mismatch
- Composite rendering statistics
- Empty frame handling
- Large point cloud performance

**Coverage**: 90%+ for all new code

## Integration with Go Backend

The Go backend (M3.5 Track B) sends:

1. **Initial background frame**: Full background snapshot with seq=1
2. **Continuous foreground frames**: Foreground points + clusters + tracks + `backgroundSeq=1`
3. **Background refresh**: New background snapshot with seq=2 (on grid reset)

The visualiser automatically detects sequence mismatches and invalidates the cache.

## Future Enhancements (M3.6+)

- **Delta frames**: Incremental background updates (type=3)
- **Compression**: Further bandwidth reduction using voxel grid decimation
- **Multi-sensor**: Support for multiple background caches (one per sensor)

## See Also

- `docs/lidar/m3.5-split-streaming-design.md` - Overall M3.5 design
- `docs/lidar/m4-tracking-milestone.md` - M4 tracking features
- `proto/velocity_visualiser/v1/visualiser.proto` - Protobuf schema
