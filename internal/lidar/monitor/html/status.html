<!DOCTYPE html>
<html>

<head>
  <title>Lidar Monitor - {{.SensorID}}</title>
  <link rel="stylesheet" href="/assets/common.css">
  <link rel="stylesheet" href="/assets/status_dashboard.css">
</head>

<body>
  <div class="grid-container">
    <h1>LiDAR Monitor - {{.SensorID}}</h1>
    <div class="card">
      <h2>Configuration</h2>
      <table border="1" cellpadding="5" cellspacing="0">
        <tr>
          <td>
            <strong>Mode:</strong>
          </td>
          <td>
            <strong>{{.Mode}}</strong>
          </td>
        </tr>
        <tr>
          <td>
            <strong>Version:</strong>
          </td>
          <td>{{.Version}}</td>
        </tr>
        <tr>
          <td>
            <strong>Git SHA:</strong>
          </td>
          <td>{{.GitSHA}}</td>
        </tr>
        <tr>
          <td>
            <strong>Build Time:</strong>
          </td>
          <td>{{.BuildTime}}</td>
        </tr>
        {{if .PCAPSafeDir}}
        <tr>
          <td>
            <strong>PCAP Safe Directory:</strong>
          </td>
          <td>{{.PCAPSafeDir}}</td>
        </tr>
        {{end}}
        {{if .PCAPFile}}
        <tr>
          <td>
            <strong>PCAP File:</strong>
          </td>
          <td>{{.PCAPFile}}</td>
        </tr>
        {{end}}
        {{if .PCAPInProgress}}
        <tr>
          <td>
            <strong>PCAP Speed Mode:</strong>
          </td>
          <td>{{.PCAPSpeedMode}}{{if .PCAPSpeedRatio}} (ratio: {{printf "%.2f"
            .PCAPSpeedRatio}}){{end}}</td>
        </tr>
        {{end}}
        <tr>
          <td>
            <strong>PCAP In Progress:</strong>
          </td>
          <td>{{.PCAPInProgress}}</td>
        </tr>
        <tr>
          <td>
            <strong>UDP Port:</strong>
          </td>
          <td>{{.UDPPort}}</td>
        </tr>
        <tr>
          <td>
            <strong>HTTP Address:</strong>
          </td>
          <td>{{.HTTPAddress}}</td>
        </tr>
        <tr>
          <td>
            <strong>Packet Forwarding:</strong>
          </td>
          <td>{{.ForwardingStatus}}</td>
        </tr>
        <tr>
          <td>
            <strong>Packet Parsing:</strong>
          </td>
          <td>{{.ParsingStatus}}</td>
        </tr>
        <tr>
          <td>
            <strong>Uptime:</strong>
          </td>
          <td>{{.Uptime}}</td>
        </tr>
      </table>
    </div>

    {{if .BGParams}}
    <div class="card">
      <h2>LIDAR Configuration</h2>

      <!-- JSON Editor Form -->
      <h3>Update Parameters (JSON)</h3>
      <form action="/api/lidar/params?sensor_id={{.SensorID}}" method="POST">
        <textarea name="config_json" rows="{{.BGParamsJSONLines}}">{{.BGParamsJSON}}</textarea>
        <button type="submit">Update
          Params</button>
      </form>
    </div>
    {{end}}

    <div class="card">
      {{if .Stats}}
      <h2>Latest Statistics</h2>
      <p><strong>Data Rate:</strong> {{printf "%.2f" .Stats.MBPerSec}}
        MB/sec</p>
      <p><strong>Packet Rate:</strong> {{printf "%.1f" .Stats.PacketsPerSec}}
        packets/sec</p>
      {{if .Stats.ParseEnabled}}
      <p><strong>Point Rate:</strong> {{printf "%.0f" .Stats.PointsPerSec}}
        points/sec</p>
      {{end}}
      {{if gt .Stats.DroppedCount 0}}
      <p><strong>Dropped Packets:</strong> {{.Stats.DroppedCount}} (forwarding
        backpressure)</p>
      {{end}}
      <p><strong>Last Updated:</strong> {{.Stats.Timestamp.Format
        "15:04:05"}}</p>
      {{else}}
      <p><em>No statistics available yet...</em></p>
      {{end}}
    </div>

    {{if .FgSnapshotCounts}}
    <div class="card">
      <h2>Latest Foreground Snapshot</h2>
      <table border="1" cellpadding="5" cellspacing="0">
        <tr>
          <td><strong>Total Points:</strong></td>
          <td>{{index .FgSnapshotCounts "total"}}</td>
        </tr>
        <tr>
          <td><strong>Foreground Points:</strong></td>
          <td>{{index .FgSnapshotCounts "foreground"}}</td>
        </tr>
        <tr>
          <td><strong>Background Points:</strong></td>
          <td>{{index .FgSnapshotCounts "background"}}</td>
        </tr>
      </table>
    </div>
    {{end}}

    <!-- API Endpoints -->
    <div class="card">
      <h3>System</h3>
      <ul>
        <li>
          <a href="/health">Health Check</a>
        </li>
        <li>
          <a href="/api/lidar/status?sensor_id={{.SensorID}}" target="_blank">
            LiDAR Status (JSON)
          </a>
        </li>
        <li>
          <a href="/api/lidar/monitor?sensor_id={{.SensorID}}" target="_blank">
            LiDAR Monitor (HTML)
          </a>
        </li>
        <li>
          <a href="/api/lidar/data_source?sensor_id={{.SensorID}}" target="_blank">
            Data Source Status (live/pcap/pcap_analysis)
          </a>
        </li>
        <li>
          <a href="/debug/lidar?sensor_id={{.SensorID}}" target="_blank">
            LiDAR Debug Dashboard (iframes)
          </a>
        </li>
      </ul>
    </div>
    <div class="card">
      <h3>Background Grid</h3>
      <ul>
        <li>
          <a href="/api/lidar/params?sensor_id={{.SensorID}}" target="_blank">
            Get/Update Background Parameters
          </a>
        </li>
        <li>
          <a href="/api/lidar/background/grid?sensor_id={{.SensorID}}" target="_blank">
            Full Background Grid (JSON)
          </a>
        </li>
        <li>
          <a href="/api/lidar/grid_status?sensor_id={{.SensorID}}" target="_blank">
            Grid Status
          </a>
        </li>
        <li>
          <a href="/api/lidar/grid_heatmap?sensor_id={{.SensorID}}" target="_blank">
            Grid Heatmap
          </a>
        </li>
        <li>
          <form action="/api/lidar/grid_reset?sensor_id={{.SensorID}}" method="POST" target="_blank"
            style="display:inline; margin:0;">
            <button type="submit">&#x1F6A8; Reset Grid &#x1F6A8;</button>
          </form>
        </li>
        <li>
          <a href="/debug/lidar/background/polar?sensor_id={{.SensorID}}" target="_blank">
            Debug Polar Plot (visual)
          </a>
        </li>
        <li>
          <a href="/debug/lidar/background/heatmap?sensor_id={{.SensorID}}" target="_blank">
            Background Heatmap (visual)
          </a>
        </li>
        <li>
          <a href="/api/lidar/acceptance?sensor_id={{.SensorID}}" target="_blank">
            Background Acceptance Metrics
          </a>
        </li>
        <li>
          <form action="/api/lidar/acceptance/reset?sensor_id={{.SensorID}}" method="POST" target="_blank"
            style="display:inline; margin:0;">
            <button type="submit">&#x1F6A8; Reset Acceptance Metrics
              &#x1F6A8;</button>
          </form>
        </li>
      </ul>
    </div>
    <div class="card">
      <h3>Background Snapshots</h3>
      <ul>
        <li>
          <form action="/api/lidar/persist?sensor_id={{.SensorID}}" method="POST" target="_blank"
            style="display:inline; margin:0;">
            <button type="submit">Save Background Snapshot</button>
          </form>
        </li>
        <li>
          <a href="/api/lidar/snapshot?sensor_id={{.SensorID}}" target="_blank">
            Get Latest Snapshot
          </a>
        </li>
        <li>
          <a href="/api/lidar/snapshots?sensor_id={{.SensorID}}" target="_blank">
            List Recent Snapshots
          </a>
        </li>
        <li>
          <form action="/api/lidar/snapshots/cleanup?sensor_id={{.SensorID}}" method="POST" target="_blank"
            style="display:inline; margin:0;">
            <button type="submit">&#x1F6A8; Delete Duplicate Snapshots
              &#x1F6A8;</button>
          </form>
        </li>
        <li>
          <a href="/api/lidar/export_snapshot?sensor_id={{.SensorID}}">
            Export Latest Snapshot to ASC
          </a>
        </li>
        <li>
          <a href="/api/lidar/export_next_frame?sensor_id={{.SensorID}}">
            Export Next Completed Frame to ASC
          </a>
        </li>
        <li>
          <a href="/api/lidar/export_frame_sequence?sensor_id={{.SensorID}}">
            Export Sequence (1 bg + 5 frames + 5 foreground)
          </a>
        </li>
      </ul>
    </div>
    <div class="card">
      <h3>PCAP Replay</h3>
      <ul>
        <li>
          <form action="/api/lidar/pcap/start?sensor_id={{.SensorID}}" method="POST" target="_blank">

            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label>Scene:</label>
                <select id="scene-select-{{.SensorID}}" style="margin-bottom: 8px;">
                  <option value="">(manual entry)</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label>Replay File
                  {{if .PCAPSafeDir}}(from {{.PCAPSafeDir}}){{end}}:
                </label>
                <input type="text" name="pcap_file" id="pcap-file-{{.SensorID}}" placeholder="filename.pcap" required />
              </div>
              <div class="form-group">
                <label>FG Debug:</label>
                <select name="enable_debug">
                  <option value="false" selected>Off</option>
                  <option value="true">On</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group form-inline">
                <input type="checkbox" name="analysis_mode" value="true" id="chk_analysis" />
                <label for="chk_analysis" style="font-weight: normal; margin: 0;">Preserve
                  grid</label>
              </div>
              <div class="form-group form-inline">
                <input type="checkbox" name="enable_plots" value="true" id="chk_plots" />
                <label for="chk_plots" style="font-weight: normal; margin: 0;">Generate
                  Plots</label>
              </div>
            </div>

            <div class="form-grid-2">
              <div class="form-group">
                <label>Speed Mode:</label>
                <select name="speed_mode" id="pcap-speed-mode-{{.SensorID}}">
                  <option value="fastest">Fastest</option>
                  <option value="realtime" selected>Realtime (1x)</option>
                  <option value="fixed">Fixed ratio</option>
                </select>
              </div>
              <div class="form-group">
                <label>Speed Ratio:</label>
                <input type="number" name="speed_ratio" id="pcap-speed-ratio-{{.SensorID}}" min="0.01" step="0.1"
                  value="1.0" disabled />
              </div>
            </div>

            <div class="form-grid-2">
              <div class="form-group">
                <label>Start (seconds):</label>
                <input type="number" name="start_seconds" id="pcap-start-{{.SensorID}}" min="0" step="0.1" value="0" />
              </div>
              <div class="form-group">
                <label>Duration (seconds, -1=all):</label>
                <input type="number" name="duration_seconds" id="pcap-duration-{{.SensorID}}" step="0.1" value="-1" />
              </div>

              <div class="form-group">
                <label>Debug Ring Min:</label>
                <input type="number" name="debug_ring_min" min="0" max="39" step="1" value="0" />
              </div>
              <div class="form-group">
                <label>Debug Ring Max:</label>
                <input type="number" name="debug_ring_max" min="0" max="39" step="1" value="0" />
              </div>

              <div class="form-group">
                <label>Debug Az Min (deg):</label>
                <input type="number" name="debug_az_min" min="0" max="360" step="0.1" value="0" />
              </div>
              <div class="form-group">
                <label>Debug Az Max (deg):</label>
                <input type="number" name="debug_az_max" min="0" max="360" step="0.1" value="0" />
              </div>
            </div>

            <div class="form-row">
              <button type="submit">Run PCAP</button>
            </div>
          </form>
          <script>
            (function () {
              try {
                var select = document.getElementById('pcap-speed-mode-{{.SensorID}}');
                var ratio = document.getElementById('pcap-speed-ratio-{{.SensorID}}');
                if (!select || !ratio) return;
                function update() {
                  ratio.disabled = (select.value !== 'fixed');
                }
                select.addEventListener('change', update);
                update();
              } catch (e) {
                // no-op: keep template resilient to missing elements
              }
            })();
          </script>
          <script>
            (function () {
              try {
                var sceneSelect = document.getElementById('scene-select-{{.SensorID}}');
                var pcapFile = document.getElementById('pcap-file-{{.SensorID}}');
                var startSecs = document.getElementById('pcap-start-{{.SensorID}}');
                var durationSecs = document.getElementById('pcap-duration-{{.SensorID}}');
                if (!sceneSelect || !pcapFile) return;

                var scenesData = [];

                fetch('/api/lidar/scenes?sensor_id={{.SensorID}}')
                  .then(function (r) { return r.json(); })
                  .then(function (data) {
                    scenesData = data.scenes || [];
                    scenesData.forEach(function (s) {
                      var opt = document.createElement('option');
                      opt.value = s.scene_id;
                      var label = s.pcap_file;
                      if (s.description) label = s.description + ' (' + s.pcap_file + ')';
                      opt.textContent = label;
                      sceneSelect.appendChild(opt);
                    });
                  })
                  .catch(function () { /* ignore fetch errors */ });

                sceneSelect.addEventListener('change', function () {
                  var sceneId = sceneSelect.value;
                  if (!sceneId) return;
                  var scene = scenesData.find(function (s) { return s.scene_id === sceneId; });
                  if (!scene) return;
                  pcapFile.value = scene.pcap_file;
                  if (startSecs && scene.pcap_start_secs != null) {
                    startSecs.value = scene.pcap_start_secs;
                  }
                  if (durationSecs && scene.pcap_duration_secs != null) {
                    durationSecs.value = scene.pcap_duration_secs;
                  }
                });
              } catch (e) {
                // no-op
              }
            })();
          </script>
        </li>
        <li>
          <form action="/api/lidar/pcap/stop?sensor_id={{.SensorID}}" method="POST" target="_blank"
            style="display:inline; margin:0;">
            <button type="submit">Stop PCAP Replay (resets grid)</button>
          </form>
        </li>
        <li>
          <form action="/api/lidar/pcap/resume_live?sensor_id={{.SensorID}}" method="POST" target="_blank"
            style="display:inline; margin:0;">
            <button type="submit">Resume Live from PCAP Analysis (preserves
              grid)</button>
          </form>
        </li>
      </ul>
    </div>
    <div class="card">
      <h3>Tracking</h3>
      <ul>
        <li>
          <a href="/api/lidar/tracks?sensor_id={{.SensorID}}" target="_blank">
            List All Tracks
          </a>
        </li>
        <li>
          <a href="/api/lidar/tracks/active?sensor_id={{.SensorID}}" target="_blank">
            Active Tracks
          </a>
        </li>
        <li>
          <a href="/api/lidar/tracks/summary?sensor_id={{.SensorID}}" target="_blank">
            Track Summary Statistics
          </a>
        </li>
        <li>
          <a href="/api/lidar/clusters?sensor_id={{.SensorID}}" target="_blank">
            List Clusters
          </a>
        </li>
        <li>
          <a href="/debug/lidar/clusters?sensor_id={{.SensorID}}" target="_blank">
            Clusters (visual)
          </a>
        </li>
        <li>
          <a href="/debug/lidar/foreground?sensor_id={{.SensorID}}" target="_blank">
            Foreground Frame (visual)
          </a>
        </li>
        <li>
          <a href="/api/lidar/export_foreground?sensor_id={{.SensorID}}" target="_blank">
            Export Latest Foreground to ASC
          </a>
        </li>
        <li>
          <a href="/debug/lidar/tracks?sensor_id={{.SensorID}}" target="_blank">
            Tracks (visual)
          </a>
        </li>
        <li>
          <form action="/api/lidar/tracks/clear" method="post" target="_blank" style="margin: 0;">
            <input type="hidden" name="sensor_id" value="{{.SensorID}}" />
            <button type="submit">&#x1F6A8; Clear Tracks + Observations
              &#x1F6A8;</button>
          </form>
        </li>
        <li>
          <form action="/api/lidar/runs/clear?sensor_id={{urlquery .SensorID}}" method="post" target="_blank" style="margin: 0;">
            <button type="submit">&#x1F6A8; Clear Runs &#x1F6A8;</button>
          </form>
        </li>
      </ul>
    </div>
  </div>
</body>

</html>
