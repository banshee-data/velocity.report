<!doctype html>
<html>

<head>
  <title>LiDAR Parameter Sweep — %[1]s</title>
  <meta name="sensor-id" content="%[1]s" />
  <link rel="stylesheet" href="/assets/common.css" />
  <link rel="stylesheet" href="/assets/sweep_dashboard.css" />
  <script src="/assets/echarts.min.js"></script>
</head>

<body>
  <h1>LiDAR Parameter Sweep</h1>
  <p class="sub">
    Sweep tuning parameters and visualise results to identify optimal tuning.
    Sensor: %[1]s
  </p>

  <div id="error-box" class="error-box" style="display: none"></div>

  <!-- Mode Toggle -->
  <div class="mode-toggle">
    <button id="mode-manual" class="active" onclick="setMode('manual')">
      Manual Sweep
    </button>
    <button id="mode-auto" onclick="setMode('auto')">Auto-Tune</button>
  </div>

  <!-- Recommendation (shown when auto-tune completes) -->
  <div id="recommendation-card" class="card recommendation-card" style="display: none">
    <h2>
      Recommendation
      <button class="btn-sm btn-add" id="btn-apply-recommendation" onclick="applyRecommendation()"
        style="margin-left: 8px">
        Apply to System
      </button>
    </h2>
    <div id="recommendation-content"></div>
  </div>

  <!-- Config Sections Container -->
  <div id="config-container">
    <!-- Sweep Parameters Card (full width) -->
    <div id="sweep-params-section">
      <div class="card">
        <h2>Sweep Parameters</h2>
        <div id="param-rows"></div>
        <button class="btn-sm btn-add" onclick="addParamRow()">
          + Add Parameter
        </button>
        <div id="sweep-summary"></div>
      </div>
    </div>

    <!-- Other Configuration Cards (multi-column) -->
    <div id="other-config-section">
      <!-- Card 1: Data Source -->
      <div class="card">
        <h2>Data Source</h2>
        <div class="field-stack">
          <label><span>Source</span>
            <select id="data_source" onchange="togglePCAP()">
              <option value="live">Live</option>
              <option value="pcap">PCAP Replay</option>
              <option value="scene">Scene</option>
            </select>
          </label>
        </div>
        <div id="pcap-fields" class="pcap-fields field-stack" style="display: none">
          <label><span>PCAP File</span><input id="pcap_file" type="text" placeholder="static/recording.pcapng" />
            <small class="field-desc">Relative path within the PCAP directory.</small>
          </label>
          <label><span>Start</span><input id="pcap_start_secs" type="number" step="0.1" value="0" min="0" />
            <small class="field-desc">Offset in seconds from the beginning of the PCAP.</small>
          </label>
          <label><span>Duration</span><input id="pcap_duration_secs" type="number" step="0.1" value="-1" />
            <small class="field-desc">Seconds of PCAP to replay. -1 = entire file.</small>
          </label>
        </div>
        <div id="scene-fields" class="field-stack" style="display: none">
          <label><span>Scene</span>
            <select id="scene_select" onchange="onSweepSceneSelected()">
              <option value="">Loading scenes...</option>
            </select>
            <small class="field-desc">Select a pre-configured scene. PCAP settings will be populated
              automatically.</small>
          </label>
          <div id="scene-info" style="
                display: none;
                font-size: 0.85em;
                color: var(--fg-muted);
                padding: 4px 0;
              "></div>
          <div id="scene-actions" style="display: none; margin-top: 8px">
            <button class="btn-sm btn-secondary" onclick="applySceneParams()" id="btn-apply-scene-params">
              Apply Scene Params
            </button>
          </div>
        </div>

        <hr style="
              margin: 16px 0;
              border: none;
              border-top: 1px solid var(--card-border);
            " />

        <!-- Start/Stop Button -->
        <div style="
              margin-top: 12px;
              margin-bottom: 12px;
              position: relative;
              height: 36px;
            ">
          <button id="btn-start" class="btn btn-primary" onclick="handleStart()"
            style="width: 100%; position: absolute; top: 0; left: 0">
            Start Sweep
          </button>
          <button id="btn-stop" class="btn btn-danger" onclick="handleStop()" style="
                display: none;
                width: 100%;
                position: absolute;
                top: 0;
                left: 0;
              ">
            Stop Sweep
          </button>
          <div id="stopping-indicator" style="
                display: none;
                width: 100%;
                text-align: center;
                padding: 8px;
                background: #ffe6e6;
                color: #cc0000;
                border: 1px solid #ffcccc;
                border-radius: 4px;
                position: absolute;
                top: 0;
                left: 0;
              ">
            <span>Stopping...</span>
          </div>
        </div>

        <!-- Progress -->
        <div id="progress-section" style="display: none">
          <div class="progress-info">
            <span>Status:
              <span id="status-badge" class="status-badge status-idle">idle</span></span>
            <span id="combo-count"></span>
          </div>
          <div id="current-combo"></div>
          <div id="sweep-error" class="error-box" style="display: none"></div>
          <div id="sweep-warnings" style="display: none"></div>
        </div>
      </div>

      <!-- Card 2: Sweep Configuration -->
      <div class="card">
        <h2>Sweep Configuration</h2>
        <div class="field-stack">
          <label><span>Seed Behaviour</span>
            <select id="seed">
              <option value="true">True</option>
              <option value="false">False</option>
              <option value="toggle">Toggle</option>
            </select>
            <small class="field-desc">Whether the background grid seeds from the first observation.
              "toggle" tests both true and false for each combination.</small>
          </label>
          <label><span>Iterations</span><input id="iterations" type="number" value="10" min="1" max="500" />
            <small class="field-desc">Number of samples per parameter combination. Higher = more
              statistical confidence.</small>
          </label>
          <label><span>Interval</span><input id="interval" type="text" value="2s" />
            <small class="field-desc">Time between consecutive samples within one combination.</small>
          </label>
          <label><span>Settle Time</span><input id="settle_time" type="text" value="5s" />
            <small class="field-desc">Wait time after changing parameters before sampling
              begins.</small>
          </label>
          <label><span>Region Settle</span>
            <select id="settle_mode" onchange="updateSweepSummary()">
              <option value="once" selected>Settle Once (reuse)</option>
              <option value="per_combo">Per Combo</option>
            </select>
            <small class="field-desc">"Per Combo": full settle each combination. "Settle Once": first
              combo settles, rest restore regions.</small>
          </label>
        </div>
      </div>

      <!-- Card 3: Scene (manual mode only) -->
      <div class="card scene-card manual-only">
        <h2>Scene</h2>
        <div class="scene-card-content">
          <div class="scene-bar">
            <button class="btn-sm btn-secondary" onclick="downloadScene()">
              Download JSON
            </button>
            <button class="btn-sm btn-secondary" onclick="document.getElementById('scene-upload').click()">
              Upload JSON
            </button>
            <input id="scene-upload" type="file" accept=".json" style="display: none" onchange="uploadScene(this)" />
            <button class="btn-sm btn-secondary" onclick="toggleJSONEditor()">
              Edit JSON
            </button>
            <button id="btn-apply-json" class="btn-sm btn-add" onclick="applyJSONEditor()" style="display: none">
              Apply
            </button>
          </div>
          <div id="json-editor-wrap" style="display: none">
            <textarea id="scenario-json"></textarea>
          </div>
        </div>
      </div>

      <!-- Card 3 (auto mode): Auto-Tune Settings -->
      <div class="card auto-only">
        <h2>Auto-Tune Settings</h2>
        <div class="field-stack">
          <label><span>Max Rounds</span><input id="max_rounds" type="number" value="3" min="1" max="10" />
            <small class="field-desc">Number of refinement rounds. Each round narrows parameter
              bounds from the best results.</small>
          </label>
          <label><span>Values / Param</span><input id="values_per_param" type="number" value="5" min="2" max="20" />
            <small class="field-desc">Grid points sampled per parameter per round. E.g. 5 values
              across 2 params = 25 combos/round.</small>
          </label>
          <label><span>Top K</span><input id="top_k" type="number" value="5" min="1" max="50" />
            <small class="field-desc">Best results used to narrow bounds for the next round.</small>
          </label>
          <label><span>Objective</span>
            <select id="objective" onchange="toggleWeights()">
              <option value="acceptance">Acceptance Rate</option>
              <option value="weighted">Weighted (custom)</option>
              <option value="ground_truth" id="ground_truth_option" style="display: none">
                Ground Truth
              </option>
            </select>
            <small class="field-desc">Scoring function for ranking combinations. Ground Truth
              requires a scene with reference run.</small>
          </label>
        </div>
        <div id="weight-fields" style="display: none; margin-top: 10px">
          <div class="field-stack">
            <label><span>Accept Weight</span><input id="w_acceptance" type="number" step="0.1" value="1.0" />
              <small class="field-desc">Weight for acceptance rate (positive = maximise).</small>
            </label>
            <label><span>Misalign Weight</span><input id="w_misalignment" type="number" step="0.1" value="-0.5" />
              <small class="field-desc">Weight for misalignment ratio (negative = minimise).</small>
            </label>
            <label><span>Align Weight</span><input id="w_alignment" type="number" step="0.01" value="-0.01" />
              <small class="field-desc">Weight for alignment degrees (negative = minimise).</small>
            </label>
            <label><span>Cells Weight</span><input id="w_nonzero" type="number" step="0.1" value="0.1" />
              <small class="field-desc">Weight for log(nonzero cells) (positive = maximise).</small>
            </label>
            <label><span>Tracks Weight</span><input id="w_active_tracks" type="number" step="0.1" value="0.3" />
              <small class="field-desc">Weight for log(active tracks) (positive = maximise).</small>
            </label>
            <label><span>Capture Weight</span><input id="w_foreground_capture" type="number" step="0.1" value="0" />
              <small class="field-desc">Weight for foreground capture ratio (positive = maximise).</small>
            </label>
            <label><span>Empty Box Weight</span><input id="w_empty_boxes" type="number" step="0.1" value="0" />
              <small class="field-desc">Weight for empty box ratio (negative = minimise).</small>
            </label>
            <label><span>Fragment Weight</span><input id="w_fragmentation" type="number" step="0.1" value="0" />
              <small class="field-desc">Weight for fragmentation ratio (negative = minimise).</small>
            </label>
            <label><span>Jitter Weight</span><input id="w_heading_jitter" type="number" step="0.01" value="0" />
              <small class="field-desc">Weight for heading jitter degrees (negative = minimise).</small>
            </label>
          </div>
        </div>
        <div id="acceptance-criteria-fields" style="display: none; margin-top: 10px">
          <h3 style="margin: 0 0 8px 0; font-size: 0.95em">Acceptance Criteria</h3>
          <small class="field-desc" style="display: block; margin-bottom: 8px">Hard thresholds that reject combinations
            before scoring. Leave blank for no constraint.</small>
          <div class="field-stack">
            <label><span>Max Fragmentation</span><input id="ac_max_fragmentation" type="number" step="0.01"
                placeholder="e.g. 0.5" />
              <small class="field-desc">Maximum fragmentation ratio allowed (0-1).</small>
            </label>
            <label><span>Max Unbounded</span><input id="ac_max_unbounded" type="number" step="0.01"
                placeholder="e.g. 0.3" />
              <small class="field-desc">Maximum unbounded point ratio allowed (0-1).</small>
            </label>
            <label><span>Max Empty Boxes</span><input id="ac_max_empty_boxes" type="number" step="0.01"
                placeholder="e.g. 0.2" />
              <small class="field-desc">Maximum empty box ratio allowed (0-1).</small>
            </label>
          </div>
        </div>
      </div>

      <!-- Card 4: Current Tuning Parameters -->
      <div class="card">
        <h2>Current Tuning Parameters</h2>
        <div class="current-params-header">
          <small class="field-desc">Swept parameters highlighted in yellow.</small>
          <button class="refresh-params-btn" onclick="fetchCurrentParams()">
            Refresh
          </button>
        </div>
        <div id="current-params-display">Loading...</div>
      </div>
    </div>
    <!-- End other-config-section -->
  </div>
  <!-- End config-container -->

  <!-- Sweep History -->
  <div id="sweep-history-bar">
    <label><span>History</span>
      <select id="sweep-history-select" onchange="onSweepHistorySelected()">
        <option value="">Current (live)</option>
      </select>
    </label>
    <button class="btn-sm btn-secondary" onclick="loadSweepHistory()">Refresh</button>
  </div>

  <!-- Charts (dynamically built) -->
  <div id="charts-section">
    <div id="chart-toolbar">
      <button class="btn-sm btn-add" onclick="openChartModal()">+ Add Chart</button>
      <button class="btn-sm btn-secondary" id="btn-save-charts" onclick="saveChartConfigs()" style="display:none">Save
        Charts</button>
    </div>
    <div id="chart-grid"></div>

    <!-- Results Table -->
    <div id="results-card" class="card">
      <h2>
        Results Table
        <button class="btn-sm btn-secondary" onclick="downloadCSV()" style="margin-left: 8px">
          Download CSV
        </button>
      </h2>
      <div style="overflow-x: auto">
        <table>
          <thead id="results-head">
            <tr>
              <th>Parameters</th>
              <th>Accept Rate</th>
              <th>± StdDev</th>
              <th>Nonzero Cells</th>
              <th>± StdDev</th>
              <th>Active Tracks</th>
              <th>Alignment (deg)</th>
              <th>Misalignment</th>
              <th>Fg Capture</th>
              <th>Unbounded</th>
              <th>Empty Box</th>
              <th>Fragmentation</th>
              <th>Jitter (deg)</th>
            </tr>
          </thead>
          <tbody id="results-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Chart Config Modal -->
  <div id="chart-modal" class="modal-overlay" style="display:none">
    <div class="modal-content card">
      <h2 id="chart-modal-title">Add Chart</h2>
      <div class="field-stack">
        <label><span>Title</span><input id="chart-cfg-title" type="text" placeholder="Chart title" /></label>
        <label><span>Type</span>
          <select id="chart-cfg-type" onchange="onChartTypeChange()">
            <option value="bar">Bar</option>
            <option value="line">Line</option>
            <option value="scatter">Scatter</option>
            <option value="heatmap">Heatmap</option>
          </select>
        </label>
        <label><span>X Axis</span>
          <select id="chart-cfg-x"></select>
        </label>
        <label><span>Y Axis</span>
          <select id="chart-cfg-y"></select>
        </label>
        <label id="chart-cfg-z-row"><span>Color (Z)</span>
          <select id="chart-cfg-z"></select>
        </label>
        <label id="chart-cfg-group-row"><span>Group By</span>
          <select id="chart-cfg-group">
            <option value="">(none)</option>
          </select>
        </label>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeChartModal()">Cancel</button>
        <button class="btn btn-primary" onclick="applyChartModal()">Apply</button>
      </div>
      <input id="chart-cfg-id" type="hidden" />
    </div>
  </div>

  <script src="/assets/dashboard_common.js"></script>
  <script src="/assets/sweep_dashboard.js"></script>
</body>

</html>
