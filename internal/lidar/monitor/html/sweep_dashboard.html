<!doctype html>
<html>

<head>
  <title>LiDAR Parameter Sweep — %[1]s</title>
  <meta name="sensor-id" content="%[1]s" />
  <link rel="stylesheet" href="/assets/common.css" />
  <link rel="stylesheet" href="/assets/sweep_dashboard.css" />
  <script src="/assets/echarts.min.js"></script>
</head>

<body>
  <h1>LiDAR Parameter Sweep</h1>
  <p class="sub">
    Sweep tuning parameters and visualise results to identify optimal tuning.
    Sensor: %[1]s
  </p>

  <div id="error-box" class="error-box" style="display: none"></div>

  <!-- Mode Toggle -->
  <div class="mode-toggle">
    <button id="mode-manual" class="active" onclick="setMode('manual')">
      Manual Sweep
    </button>
    <button id="mode-auto" onclick="setMode('auto')">Auto-Tune</button>
    <button id="mode-hint" onclick="setMode('hint')">Human-in-the-Loop</button>
  </div>

  <!-- Mode Descriptions -->
  <p class="mode-description auto-only">
    Auto-Tune iteratively narrows parameter bounds across multiple rounds, scoring each combination automatically.
  </p>
  <p class="mode-description hint-only">
    Human-in-the-Loop runs reference scenes, waits for you to label tracks, then sweeps using ground truth scores.
    Repeat for each round.
  </p>

  <!-- Recommendation (shown when auto-tune or HINT completes) -->
  <div id="recommendation-card" class="card recommendation-card" style="display: none">
    <h2>
      Recommendation
      <button class="btn-sm btn-add" id="btn-apply-recommendation" onclick="applyRecommendation()"
        style="margin-left: 8px">
        Apply to System
      </button>
    </h2>
    <div id="recommendation-content"></div>
    <details id="recommendation-explanation" style="margin-top: 12px; display: none">
      <summary style="cursor: pointer; font-size: 0.9em; color: var(--accent)">Why this recommendation?</summary>
      <div id="recommendation-explanation-body"
        style="margin-top: 8px; font-size: 0.85em; padding: 8px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 4px">
        <div id="rec-explain-top" style="margin-bottom: 8px"></div>
        <table id="rec-explain-table" style="width: 100%%; border-collapse: collapse">
          <thead>
            <tr style="text-align: left; border-bottom: 1px solid var(--border)">
              <th style="padding: 3px 6px">Metric</th>
              <th style="padding: 3px 6px">Value</th>
              <th style="padding: 3px 6px">Δ vs Previous</th>
            </tr>
          </thead>
          <tbody id="rec-explain-tbody"></tbody>
        </table>
      </div>
    </details>
  </div>

  <!-- Score Explanation Card (shown after auto-tune or HINT completes) -->
  <div id="explanation-card" class="card" style="display: none">
    <h2>Score Explanation</h2>
    <div id="explanation-objective" style="margin-bottom: 8px">
      <span class="label">Objective:</span>
      <span id="explanation-objective-name"></span>
      <span id="explanation-objective-version" style="color: var(--muted)"></span>
    </div>
    <div id="explanation-composite" style="margin-bottom: 12px">
      <span class="label">Composite Score:</span>
      <strong id="explanation-composite-score"></strong>
    </div>
    <div id="explanation-top-contributors" style="margin-bottom: 12px">
      <span class="label">Top Contributors:</span>
      <span id="explanation-top-list"></span>
    </div>
    <div id="explanation-label-coverage" style="margin-bottom: 12px">
      <span class="label">Label Coverage:</span>
      <span id="explanation-label-pct"></span>
    </div>
    <table id="explanation-components-table" style="width: 100%%; border-collapse: collapse; font-size: 0.9em">
      <thead>
        <tr style="text-align: left; border-bottom: 1px solid var(--border)">
          <th style="padding: 4px 8px">Metric</th>
          <th style="padding: 4px 8px">Contribution</th>
          <th style="padding: 4px 8px">Weight</th>
        </tr>
      </thead>
      <tbody id="explanation-components-body">
      </tbody>
    </table>
  </div>

  <!-- Config Sections Container -->
  <div id="config-container">
    <!-- Sweep Parameters Card (full width) -->
    <div id="sweep-params-section">
      <div class="card">
        <h2>Sweep Parameters</h2>
        <div id="param-rows"></div>
        <button class="btn-sm btn-add" onclick="addParamRow()">
          + Add Parameter
        </button>
        <div id="sweep-summary"></div>
      </div>
    </div>

    <!-- Other Configuration Cards (multi-column) -->
    <div id="other-config-section">
      <!-- Card 1: Data Source -->
      <div class="card">
        <h2>Data Source</h2>
        <div class="field-stack">
          <label><span>Source</span>
            <select id="data_source" onchange="togglePCAP()">
              <option value="live">Live</option>
              <option value="pcap">PCAP Replay</option>
              <option value="scene">Scene</option>
            </select>
          </label>
        </div>
        <div id="pcap-fields" class="pcap-fields field-stack" style="display: none">
          <label><span>PCAP File</span><input id="pcap_file" type="text" placeholder="static/recording.pcapng" />
            <small class="field-desc">Relative path within the PCAP directory.</small>
          </label>
          <label><span>Start</span><input id="pcap_start_secs" type="number" step="0.1" value="0" min="0" />
            <small class="field-desc">Offset in seconds from the beginning of the PCAP.</small>
          </label>
          <label><span>Duration</span><input id="pcap_duration_secs" type="number" step="0.1" value="-1" />
            <small class="field-desc">Seconds of PCAP to replay. -1 = entire file.</small>
          </label>
        </div>
        <div id="scene-fields" class="field-stack" style="display: none">
          <label><span>Scene</span>
            <select id="scene_select" onchange="onSweepSceneSelected()">
              <option value="">Loading scenes...</option>
            </select>
            <small class="field-desc">Select a pre-configured scene. PCAP settings will be populated
              automatically.</small>
          </label>
          <div id="scene-info" style="
                display: none;
                font-size: 0.85em;
                color: var(--fg-muted);
                padding: 4px 0;
              "></div>
          <div id="scene-actions" style="display: none; margin-top: 8px">
            <button class="btn-sm btn-secondary" onclick="applySceneParams()" id="btn-apply-scene-params">
              Apply Scene Params
            </button>
          </div>
        </div>

        <hr style="
              margin: 16px 0;
              border: none;
              border-top: 1px solid var(--card-border);
            " />

        <!-- Start/Stop/Suspend/Resume Buttons -->
        <div style="
              margin-top: 12px;
              margin-bottom: 12px;
              position: relative;
              min-height: 36px;
            ">
          <button id="btn-start" class="btn btn-primary" onclick="handleStart()" style="width: 100%%">
            Start Sweep
          </button>
          <div id="btn-running-actions" style="display: none; gap: 8px;">
            <button id="btn-stop" class="btn btn-danger" onclick="handleStop()" style="
                  display: none;
                  flex: 1;
                ">
              Stop
            </button>
            <button id="btn-suspend" class="btn btn-warning" onclick="handleSuspend()" style="
                  display: none;
                  flex: 1;
                ">
              Suspend
            </button>
          </div>
          <button id="btn-resume" class="btn btn-primary" onclick="handleResume()" style="
                display: none;
                width: 100%%;
              ">
            Resume Sweep
          </button>
          <div id="stopping-indicator" style="
                display: none;
                width: 100%%;
                text-align: center;
                padding: 8px;
                background: #ffe6e6;
                color: #cc0000;
                border: 1px solid #ffcccc;
                border-radius: 4px;
              ">
            <span>Stopping...</span>
          </div>
        </div>

        <!-- Suspended sweep banner (shown when DB has a suspended sweep after restart) -->
        <div id="suspended-sweep-banner" style="
              display: none;
              padding: 10px 14px;
              margin-bottom: 12px;
              background: #fff3cd;
              color: #856404;
              border: 1px solid #ffc107;
              border-radius: 4px;
              font-size: 14px;
            ">
        </div>

        <!-- Progress -->
        <div id="progress-section" style="display: none">
          <div class="progress-info">
            <span>Status:
              <span id="status-badge" class="status-badge status-idle">idle</span></span>
            <span id="combo-count"></span>
          </div>
          <div id="current-combo"></div>
          <div id="sweep-error" class="error-box" style="display: none"></div>
          <div id="sweep-warnings" style="display: none"></div>
        </div>
      </div>

      <!-- Card 2: Sweep Configuration (hidden in HINT mode via CSS) -->
      <div class="card" id="sweep-config-card">
        <h2>Sweep Configuration</h2>
        <div class="field-stack">
          <label><span>Seed Behaviour</span>
            <select id="seed">
              <option value="true">True</option>
              <option value="false">False</option>
              <option value="toggle">Toggle</option>
            </select>
            <small class="field-desc">Whether the background grid seeds from the first observation.
              "toggle" tests both true and false for each combination.</small>
          </label>
          <label><span>Iterations</span><input id="iterations" type="number" value="10" min="1" max="500" />
            <small class="field-desc">Number of samples per parameter combination. Higher = more
              statistical confidence.</small>
          </label>
          <label><span>Interval</span><input id="interval" type="text" value="2s" />
            <small class="field-desc">Time between consecutive samples within one combination.</small>
          </label>
          <label><span>Settle Time</span><input id="settle_time" type="text" value="5s" />
            <small class="field-desc">Wait time after changing parameters before sampling
              begins.</small>
          </label>
          <label><span>Region Settle</span>
            <select id="settle_mode" onchange="updateSweepSummary()">
              <option value="once" selected>Settle Once (reuse)</option>
              <option value="per_combo">Per Combo</option>
            </select>
            <small class="field-desc">"Per Combo": full settle each combination. "Settle Once": first
              combo settles, rest restore regions.</small>
          </label>
        </div>
      </div>

      <!-- Card 3: Scene (manual mode only) -->
      <div class="card scene-card manual-only">
        <h2>Scene</h2>
        <div class="scene-card-content">
          <div class="scene-bar">
            <button class="btn-sm btn-secondary" onclick="downloadScene()">
              Download JSON
            </button>
            <button class="btn-sm btn-secondary" onclick="document.getElementById('scene-upload').click()">
              Upload JSON
            </button>
            <input id="scene-upload" type="file" accept=".json" style="display: none" onchange="uploadScene(this)" />
            <button class="btn-sm btn-secondary" onclick="toggleJSONEditor()">
              Edit JSON
            </button>
            <button id="btn-apply-json" class="btn-sm btn-add" onclick="applyJSONEditor()" style="display: none">
              Apply
            </button>
          </div>
          <div id="json-editor-wrap" style="display: none">
            <textarea id="scenario-json"></textarea>
          </div>
        </div>
      </div>

      <!-- Card 3 (auto mode): Auto-Tune Settings -->
      <div class="card auto-only">
        <h2>Auto-Tune Settings</h2>
        <div class="field-stack">
          <label><span>Max Rounds</span><input id="max_rounds" type="number" value="3" min="1" max="10" />
            <small class="field-desc">Number of refinement rounds. Each round narrows parameter
              bounds from the best results.</small>
          </label>
          <label><span>Values / Param</span><input id="values_per_param" type="number" value="5" min="2" max="20" />
            <small class="field-desc">Grid points sampled per parameter per round. E.g. 5 values
              across 2 params = 25 combos/round.</small>
          </label>
          <label><span>Top K</span><input id="top_k" type="number" value="5" min="1" max="50" />
            <small class="field-desc">Best results used to narrow bounds for the next round.</small>
          </label>
          <label><span>Objective</span>
            <select id="objective" onchange="toggleWeights()">
              <option value="acceptance">Acceptance Rate</option>
              <option value="weighted">Weighted (custom)</option>
              <option value="ground_truth" id="ground_truth_option" style="display: none">
                Ground Truth
              </option>
            </select>
            <small class="field-desc">Scoring function for ranking combinations. Ground Truth
              requires a scene with reference run.</small>
          </label>
        </div>
        <div id="weight-fields" style="display: none; margin-top: 10px">
          <div class="field-stack">
            <label><span>Accept Weight</span><input id="w_acceptance" type="number" step="0.1" value="1.0" />
              <small class="field-desc">Weight for acceptance rate (positive = maximise).</small>
            </label>
            <label><span>Misalign Weight</span><input id="w_misalignment" type="number" step="0.1" value="-0.5" />
              <small class="field-desc">Weight for misalignment ratio (negative = minimise).</small>
            </label>
            <label><span>Align Weight</span><input id="w_alignment" type="number" step="0.01" value="-0.01" />
              <small class="field-desc">Weight for alignment degrees (negative = minimise).</small>
            </label>
            <label><span>Cells Weight</span><input id="w_nonzero" type="number" step="0.1" value="0.1" />
              <small class="field-desc">Weight for log(nonzero cells) (positive = maximise).</small>
            </label>
            <label><span>Tracks Weight</span><input id="w_active_tracks" type="number" step="0.1" value="0.3" />
              <small class="field-desc">Weight for log(active tracks) (positive = maximise).</small>
            </label>
            <label><span>Capture Weight</span><input id="w_foreground_capture" type="number" step="0.1" value="0" />
              <small class="field-desc">Weight for foreground capture ratio (positive = maximise).</small>
            </label>
            <label><span>Empty Box Weight</span><input id="w_empty_boxes" type="number" step="0.1" value="0" />
              <small class="field-desc">Weight for empty box ratio (negative = minimise).</small>
            </label>
            <label><span>Fragment Weight</span><input id="w_fragmentation" type="number" step="0.1" value="0" />
              <small class="field-desc">Weight for fragmentation ratio (negative = minimise).</small>
            </label>
            <label><span>Jitter Weight</span><input id="w_heading_jitter" type="number" step="0.01" value="0" />
              <small class="field-desc">Weight for heading jitter degrees (negative = minimise).</small>
            </label>
          </div>
        </div>
        <div id="acceptance-criteria-fields" style="display: none; margin-top: 10px">
          <h3 style="margin: 0 0 8px 0; font-size: 0.95em">Acceptance Criteria</h3>
          <small class="field-desc" style="display: block; margin-bottom: 8px">Hard thresholds that reject combinations
            before scoring. Leave blank for no constraint.</small>
          <div class="field-stack">
            <label><span>Max Fragmentation</span><input id="ac_max_fragmentation" type="number" step="0.01"
                placeholder="e.g. 0.5" />
              <small class="field-desc">Maximum fragmentation ratio allowed (0-1).</small>
            </label>
            <label><span>Max Unbounded</span><input id="ac_max_unbounded" type="number" step="0.01"
                placeholder="e.g. 0.3" />
              <small class="field-desc">Maximum unbounded point ratio allowed (0-1).</small>
            </label>
            <label><span>Max Empty Boxes</span><input id="ac_max_empty_boxes" type="number" step="0.01"
                placeholder="e.g. 0.2" />
              <small class="field-desc">Maximum empty box ratio allowed (0-1).</small>
            </label>
          </div>
        </div>
      </div>

      <!-- Card 3b (hint mode): HINT Settings -->
      <div class="card hint-only">
        <h2>HINT Settings</h2>
        <div id="hint-config-section" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px">
          <label>
            <span>Rounds</span>
            <input id="hint_rounds" type="number" value="3" min="1" max="10" />
            <small class="field-desc">Number of label-then-sweep rounds (1–10).</small>
          </label>
          <label>
            <span>Label threshold (%%)</span>
            <input id="hint_threshold" type="number" value="90" min="10" max="100" step="5" />
            <small class="field-desc">Minimum %% of tracks labelled before sweep (default 90).</small>
          </label>
          <label>
            <span>Carry over labels</span>
            <input id="hint_carryover" type="checkbox" checked />
            <small class="field-desc">Copy labels to next round via temporal IoU matching.</small>
          </label>
          <label>
            <span>Tune background</span>
            <input id="hint_tune_background" type="checkbox" />
            <small class="field-desc">Re-settle background grid per combo. Enable when sweeping background
              params.</small>
          </label>
          <label>
            <span>Min class coverage (JSON)</span>
            <input id="hint_class_coverage" type="text" placeholder='{"vehicle":3,"pedestrian":1}' />
            <small class="field-desc">Optional: minimum labelled tracks per class before proceeding.</small>
          </label>
          <label>
            <span>Min temporal spread (seconds)</span>
            <input id="hint_temporal_spread" type="number" value="" min="0" step="1" placeholder="0" />
            <small class="field-desc">Optional: minimum time span (seconds) covered by labelled tracks.</small>
          </label>
        </div>
      </div>

      <!-- HINT Progress Card (shown during HINT run) -->
      <div id="hint-progress-card" class="card hint-only" style="display: none">
        <h2>HINT Progress</h2>
        <div id="hint-status-text" style="margin-bottom: 8px"></div>
        <div id="hint-label-progress" style="display: none">
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px">
            <span id="hint-label-count">0/0 labelled</span>
            <span id="hint-label-pct">0%%</span>
          </div>
          <div class="progress-bar-bg"
            style="height: 16px; border-radius: 4px; background: var(--card-bg); border: 1px solid var(--card-border); position: relative">
            <div id="hint-label-bar"
              style="height: 100%%; background: var(--accent); border-radius: 3px; width: 0; transition: width 0.3s">
            </div>
            <div id="hint-threshold-marker"
              style="position: absolute; top: 0; height: 100%%; border-left: 2px dashed #cc0000; left: 90%%"
              title="90%% threshold"></div>
          </div>
          <div style="margin-top: 8px; display: flex; justify-content: flex-end; align-items: center">
            <span id="hint-carried-count" style="font-size: 12px; color: var(--fg-muted)"></span>
          </div>
          <div id="hint-gate-status"
            style="display: none; margin-top: 6px; font-size: 11px; color: var(--fg-muted); background: var(--card-bg); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--card-border)">
          </div>
          <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center">
            <label style="flex: 1">
              <span style="font-size: 12px">Next sweep duration (mins)</span>
              <input id="hint-next-duration" type="number" value="60" min="1" style="width: 80px" />
            </label>
            <label style="display: flex; align-items: center; gap: 4px">
              <input id="hint-add-round" type="checkbox" />
              <span style="font-size: 12px">Add extra round</span>
            </label>
          </div>
          <div style="margin-top: 8px; display: flex; gap: 8px">
            <a id="hint-tracks-link" href="" target="_blank" class="btn btn-sm">Open Tracks Page →</a>
            <button id="hint-continue-btn" class="btn btn-primary btn-sm" onclick="handleHINTContinue()" disabled>
              Continue to Sweep
            </button>
          </div>
        </div>
        <div id="hint-sweep-progress" style="display: none">
          <div id="hint-sweep-info" style="font-size: 12px; color: var(--fg-muted)"></div>
        </div>
      </div>

      <!-- HINT Round History (shown during/after HINT run) -->
      <div id="hint-round-history" class="card hint-only" style="display: none">
        <h2>Round History</h2>
        <div id="hint-rounds-list"></div>
      </div>

      <!-- Card 4: Current Tuning Parameters -->
      <div id="current-params-card" class="card">
        <h2>Current Tuning Parameters</h2>
        <div class="current-params-header">
          <small class="field-desc">Swept parameters highlighted in yellow.</small>
          <button class="refresh-params-btn" onclick="fetchCurrentParams()">
            Refresh
          </button>
        </div>
        <div id="current-params-display">Loading...</div>
      </div>

      <!-- Card 5: Paste & Apply Params -->
      <div id="paste-params-card" class="card">
        <h2>Paste &amp; Apply Params</h2>
        <small class="field-desc" style="display: block; margin-bottom: 8px">
          Paste a JSON object of tuning parameters (e.g. from a sweep recommendation or
          another source) and apply directly to the system. Only recognised parameter keys
          are sent; metric keys are filtered out automatically.
        </small>
        <textarea id="paste-params-json" rows="8"
          style="width: 100%%; font-family: monospace; font-size: 0.85em; resize: vertical"
          placeholder='{"foreground_dbscan_eps": 0.3, "measurement_noise": 0.9, ...}'></textarea>
        <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center">
          <button class="btn-sm btn-add" id="btn-paste-apply" onclick="applyPastedParams()">
            Apply to System
          </button>
          <button class="btn-sm btn-secondary" onclick="loadCurrentIntoEditor()">
            Load Current
          </button>
          <span id="paste-apply-status" style="font-size: 0.85em; color: var(--fg-muted)"></span>
        </div>
      </div>
    </div>
    <!-- End other-config-section -->
  </div>
  <!-- End config-container -->

  <!-- Sweep History -->
  <div id="sweep-history-bar">
    <label><span>History</span>
      <select id="sweep-history-select" onchange="onSweepHistorySelected()">
        <option value="">Current (live)</option>
      </select>
    </label>
    <button class="btn-sm btn-secondary" onclick="loadSweepHistory()">Refresh</button>
  </div>

  <!-- Charts (dynamically built) -->
  <div id="charts-section">
    <div id="chart-toolbar">
      <button class="btn-sm btn-add" onclick="openChartModal()">+ Add Chart</button>
      <button class="btn-sm btn-secondary" id="btn-save-charts" onclick="saveChartConfigs()" style="display:none">Save
        Charts</button>
    </div>
    <div id="chart-grid"></div>

    <!-- Results Table -->
    <div id="results-card" class="card">
      <h2>
        Results Table
        <button class="btn-sm btn-secondary" onclick="downloadCSV()" style="margin-left: 8px">
          Download CSV
        </button>
      </h2>
      <div style="overflow-x: auto">
        <table>
          <thead id="results-head">
            <tr>
              <th>Parameters</th>
              <th>Accept Rate</th>
              <th>± StdDev</th>
              <th>Nonzero Cells</th>
              <th>± StdDev</th>
              <th>Active Tracks</th>
              <th>Alignment (deg)</th>
              <th>Misalignment</th>
              <th>Fg Capture</th>
              <th>Unbounded</th>
              <th>Empty Box</th>
              <th>Fragmentation</th>
              <th>Jitter (deg)</th>
            </tr>
          </thead>
          <tbody id="results-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Chart Config Modal -->
  <div id="chart-modal" class="modal-overlay" style="display:none">
    <div class="modal-content card">
      <h2 id="chart-modal-title">Add Chart</h2>
      <div class="field-stack">
        <label><span>Title</span><input id="chart-cfg-title" type="text" placeholder="Chart title" /></label>
        <label><span>Type</span>
          <select id="chart-cfg-type" onchange="onChartTypeChange()">
            <option value="bar">Bar</option>
            <option value="line">Line</option>
            <option value="scatter">Scatter</option>
            <option value="heatmap">Heatmap</option>
          </select>
        </label>
        <label><span>X Axis</span>
          <select id="chart-cfg-x"></select>
        </label>
        <label><span>Y Axis</span>
          <select id="chart-cfg-y"></select>
        </label>
        <label id="chart-cfg-z-row"><span>Color (Z)</span>
          <select id="chart-cfg-z"></select>
        </label>
        <label id="chart-cfg-group-row"><span>Group By</span>
          <select id="chart-cfg-group">
            <option value="">(none)</option>
          </select>
        </label>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeChartModal()">Cancel</button>
        <button class="btn btn-primary" onclick="applyChartModal()">Apply</button>
      </div>
      <input id="chart-cfg-id" type="hidden" />
    </div>
  </div>

  <script src="/assets/dashboard_common.js"></script>
  <script src="/assets/sweep_dashboard.js"></script>
</body>

</html>
