<!doctype html>
<html>

<head>
  <title>LiDAR Parameter Sweep — %[1]s</title>
  <meta name="sensor-id" content="%[1]s" />
  <link rel="stylesheet" href="/assets/common.css" />
  <script src="/assets/echarts.min.js"></script>
  <style>
    body {
      max-width: none;
      padding: 0 24px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--fg-muted);
      margin-bottom: 8px;
    }

    .section-border {
      border: 1px solid var(--card-border);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .progress-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .chart-container {
      width: 100%%;
      height: 450px;
    }

    #charts-section {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    #charts-section>.card {
      margin-bottom: 0;
      min-width: 0;
      overflow: hidden;
    }

    @media (max-width: 1600px) {
      #charts-section {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 900px) {
      #charts-section {
        grid-template-columns: 1fr;
      }
    }

    /* Form grid override: max 3 columns */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    @media (max-width: 1600px) {
      .form-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 900px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Sweep params: wider single card */
    #sweep-params-section {
      margin-bottom: 12px;
    }

    /* Other config: narrower cards in up to 4 columns */
    #other-config-section {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }

    #other-config-section>.card {
      min-width: 0;
      margin-bottom: 0;
    }

    /* Ultra-wide: all on one line (sweep params 2x width of others) */
    @media (min-width: 3000px) {
      #config-container {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
      }

      #sweep-params-section {
        flex: 2;
        margin-bottom: 0;
      }

      #other-config-section {
        flex: 4;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        margin-bottom: 0;
      }
    }

    @media (max-width: 1800px) {
      #other-config-section {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 1200px) {
      #other-config-section {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 900px) {
      #other-config-section {
        grid-template-columns: 1fr;
      }
    }

    /* Vertical field stack for config/data-source cards with aligned inputs */
    .field-stack label {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 8px;
      align-items: start;
      margin-bottom: 10px;
    }

    .field-stack label:last-child {
      margin-bottom: 0;
    }

    .field-stack label>span {
      padding-top: 6px;
    }

    .field-stack label>select,
    .field-stack label>input {
      justify-self: stretch;
    }

    .field-stack label>small {
      grid-column: 2;
      margin-top: 4px;
    }

    /* Scenario card fills height */
    .scenario-card {
      display: flex;
      flex-direction: column;
    }

    .scenario-card>h2 {
      flex-shrink: 0;
    }

    .scenario-card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #json-editor-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #scenario-json {
      flex: 1;
      width: 100%%;
      min-height: 0;
      font-family: var(--mono);
      font-size: 12px;
      padding: 8px;
      border: 1px solid var(--input-border);
      border-radius: 5px;
      background: var(--input-bg);
      color: var(--input-fg);
      margin-top: 8px;
      resize: none;
    }

    /* Results table spans full width below charts */
    #results-card {
      grid-column: 1 / -1;
    }

    .param-row {
      display: grid;
      grid-template-columns: 200px 1fr auto;
      gap: 8px;
      align-items: end;
      margin-bottom: 8px;
    }

    .param-row select,
    .param-row input {
      min-width: 0;
    }

    .param-row .param-name {
      min-width: 0;
    }

    .param-row .param-fields {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .param-row .param-field {
      flex: 1;
      min-width: 100px;
    }

    .param-row .param-remove {
      align-self: end;
    }

    .param-desc {
      font-size: 11px;
      color: var(--fg-faint);
      margin-top: 2px;
      line-height: 1.3;
      grid-column: 1 / -1;
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    .btn-add {
      background: var(--accent);
      color: #fff;
    }

    .btn-add:hover {
      background: var(--accent-hover);
    }

    .btn-remove {
      background: var(--danger);
      color: #fff;
      padding: 6px 10px;
    }

    .btn-secondary {
      background: var(--card-border);
      color: var(--fg);
    }

    .btn-secondary:hover {
      background: var(--input-border);
    }

    #current-combo {
      font-size: 13px;
      color: var(--fg-faint);
    }

    .pcap-fields {
      margin-top: 10px;
    }

    .scenario-bar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    #sweep-summary {
      font-size: 12px;
      color: var(--fg-muted);
      padding: 8px 12px;
      margin-top: 8px;
      border: 1px solid var(--card-border);
      border-radius: 4px;
      background: var(--input-bg);
      line-height: 1.6;
    }

    #current-params-display {
      font-family: var(--mono);
      font-size: 11px;
      padding: 10px;
      border: 1px solid var(--input-border);
      border-radius: 5px;
      background: var(--input-bg);
      color: var(--fg-faint);
      max-height: 500px;
      overflow-y: auto;
      line-height: 1.6;
      margin-top: 8px;
    }

    .param-line {
      display: block;
    }

    .param-line.swept {
      background: rgba(255, 204, 0, 0.15);
      color: var(--fg);
      font-weight: 500;
      padding: 2px 4px;
      margin: 1px -4px;
      border-radius: 3px;
    }

    .current-params-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .refresh-params-btn {
      padding: 2px 8px;
      font-size: 11px;
      background: var(--card-border);
      color: var(--fg);
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .refresh-params-btn:hover {
      background: var(--input-border);
    }

    /* Mode toggle */
    .mode-toggle {
      display: inline-flex;
      margin-bottom: 12px;
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid var(--card-border);
    }

    .mode-toggle button {
      padding: 6px 16px;
      border: none;
      background: var(--card-bg);
      color: var(--fg-muted);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }

    .mode-toggle button:not(:last-child) {
      border-right: 1px solid var(--card-border);
    }

    .mode-toggle button.active {
      background: var(--accent);
      color: #fff;
    }

    /* Auto/manual visibility toggles */
    body.auto-mode .manual-only {
      display: none !important;
    }

    body:not(.auto-mode) .auto-only {
      display: none !important;
    }

    /* Hide step/values in auto mode */
    body.auto-mode .param-field-step,
    body.auto-mode .param-field-values {
      display: none !important;
    }

    /* Recommendation card */
    .recommendation-card {
      margin-bottom: 12px;
      border-left: 4px solid var(--accent);
    }

    .recommendation-params {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px;
      margin: 12px 0;
    }

    .recommendation-param {
      padding: 8px 12px;
      background: var(--input-bg);
      border: 1px solid var(--card-border);
      border-radius: 4px;
      font-family: var(--mono);
      font-size: 12px;
    }

    .recommendation-param .param-name {
      color: var(--fg-muted);
      font-size: 11px;
      margin-bottom: 2px;
    }

    .recommendation-param .param-value {
      font-weight: 600;
      font-size: 14px;
    }

    .recommendation-metrics {
      display: flex;
      gap: 16px;
      margin: 8px 0;
      font-size: 12px;
      color: var(--fg-muted);
    }

    .recommendation-metrics .metric {
      display: flex;
      gap: 4px;
    }

    .recommendation-metrics .metric-value {
      font-weight: 600;
      color: var(--fg);
    }

    .round-history {
      margin-top: 12px;
      font-size: 12px;
    }

    .round-history summary {
      cursor: pointer;
      color: var(--fg-muted);
      font-weight: 500;
      margin-bottom: 4px;
    }

    .round-history .round-item {
      padding: 6px 0;
      border-bottom: 1px solid var(--card-border);
      font-family: var(--mono);
      font-size: 11px;
      color: var(--fg-faint);
    }

    /* Auto-tune progress */
    .auto-progress {
      font-size: 12px;
      color: var(--fg-muted);
      margin-top: 4px;
    }
  </style>
</head>

<body>
  <h1>LiDAR Parameter Sweep</h1>
  <p class="sub">
    Sweep tuning parameters and visualise results to identify optimal tuning.
    Sensor: %[1]s
  </p>

  <div id="error-box" class="error-box" style="display: none"></div>

  <!-- Mode Toggle -->
  <div class="mode-toggle">
    <button id="mode-manual" class="active" onclick="setMode('manual')">
      Manual Sweep
    </button>
    <button id="mode-auto" onclick="setMode('auto')">Auto-Tune</button>
  </div>

  <!-- Recommendation (shown when auto-tune completes) -->
  <div id="recommendation-card" class="card recommendation-card" style="display: none">
    <h2>
      Recommendation
      <button class="btn-sm btn-add" id="btn-apply-recommendation" onclick="applyRecommendation()"
        style="margin-left: 8px">
        Apply to System
      </button>
    </h2>
    <div id="recommendation-content"></div>
  </div>

  <!-- Config Sections Container -->
  <div id="config-container">
    <!-- Sweep Parameters Card (full width) -->
    <div id="sweep-params-section">
      <div class="card">
        <h2>Sweep Parameters</h2>
        <div id="param-rows"></div>
        <button class="btn-sm btn-add" onclick="addParamRow()">
          + Add Parameter
        </button>
        <div id="sweep-summary"></div>
      </div>
    </div>

    <!-- Other Configuration Cards (multi-column) -->
    <div id="other-config-section">
      <!-- Card 1: Data Source -->
      <div class="card">
        <h2>Data Source</h2>
        <div class="field-stack">
          <label><span>Source</span>
            <select id="data_source" onchange="togglePCAP()">
              <option value="live">Live</option>
              <option value="pcap">PCAP Replay</option>
              <option value="scene">Scene</option>
            </select>
          </label>
        </div>
        <div id="pcap-fields" class="pcap-fields field-stack" style="display: none">
          <label><span>PCAP File</span><input id="pcap_file" type="text" placeholder="static/recording.pcapng" />
            <small class="field-desc">Relative path within the PCAP directory.</small>
          </label>
          <label><span>Start</span><input id="pcap_start_secs" type="number" step="0.1" value="0" min="0" />
            <small class="field-desc">Offset in seconds from the beginning of the PCAP.</small>
          </label>
          <label><span>Duration</span><input id="pcap_duration_secs" type="number" step="0.1" value="-1" />
            <small class="field-desc">Seconds of PCAP to replay. -1 = entire file.</small>
          </label>
        </div>
        <div id="scene-fields" class="field-stack" style="display: none">
          <label><span>Scene</span>
            <select id="scene_select" onchange="onSweepSceneSelected()">
              <option value="">Loading scenes...</option>
            </select>
            <small class="field-desc">Select a pre-configured scene. PCAP settings will be populated
              automatically.</small>
          </label>
          <div id="scene-info" style="
                display: none;
                font-size: 0.85em;
                color: var(--fg-muted);
                padding: 4px 0;
              "></div>
          <div id="scene-actions" style="display: none; margin-top: 8px">
            <button class="btn-sm btn-secondary" onclick="applySceneParams()" id="btn-apply-scene-params">
              Apply Scene Params
            </button>
          </div>
        </div>

        <hr style="
              margin: 16px 0;
              border: none;
              border-top: 1px solid var(--card-border);
            " />

        <!-- Start/Stop Button -->
        <div style="
              margin-top: 12px;
              margin-bottom: 12px;
              position: relative;
              height: 36px;
            ">
          <button id="btn-start" class="btn btn-primary" onclick="handleStart()"
            style="width: 100%; position: absolute; top: 0; left: 0">
            Start Sweep
          </button>
          <button id="btn-stop" class="btn btn-danger" onclick="handleStop()" style="
                display: none;
                width: 100%;
                position: absolute;
                top: 0;
                left: 0;
              ">
            Stop Sweep
          </button>
          <div id="stopping-indicator" style="
                display: none;
                width: 100%;
                text-align: center;
                padding: 8px;
                background: #ffe6e6;
                color: #cc0000;
                border: 1px solid #ffcccc;
                border-radius: 4px;
                position: absolute;
                top: 0;
                left: 0;
              ">
            <span>Stopping...</span>
          </div>
        </div>

        <!-- Progress -->
        <div id="progress-section" style="display: none">
          <div class="progress-info">
            <span>Status:
              <span id="status-badge" class="status-badge status-idle">idle</span></span>
            <span id="combo-count"></span>
          </div>
          <div id="current-combo"></div>
          <div id="sweep-error" class="error-box" style="display: none"></div>
          <div id="sweep-warnings" style="display: none"></div>
        </div>
      </div>

      <!-- Card 2: Sweep Configuration -->
      <div class="card">
        <h2>Sweep Configuration</h2>
        <div class="field-stack">
          <label><span>Seed Behaviour</span>
            <select id="seed">
              <option value="true">True</option>
              <option value="false">False</option>
              <option value="toggle">Toggle</option>
            </select>
            <small class="field-desc">Whether the background grid seeds from the first observation.
              "toggle" tests both true and false for each combination.</small>
          </label>
          <label><span>Iterations</span><input id="iterations" type="number" value="10" min="1" max="500" />
            <small class="field-desc">Number of samples per parameter combination. Higher = more
              statistical confidence.</small>
          </label>
          <label><span>Interval</span><input id="interval" type="text" value="2s" />
            <small class="field-desc">Time between consecutive samples within one combination.</small>
          </label>
          <label><span>Settle Time</span><input id="settle_time" type="text" value="5s" />
            <small class="field-desc">Wait time after changing parameters before sampling
              begins.</small>
          </label>
          <label><span>Region Settle</span>
            <select id="settle_mode" onchange="updateSweepSummary()">
              <option value="once" selected>Settle Once (reuse)</option>
              <option value="per_combo">Per Combo</option>
            </select>
            <small class="field-desc">"Per Combo": full settle each combination. "Settle Once": first
              combo settles, rest restore regions.</small>
          </label>
        </div>
      </div>

      <!-- Card 3: Scenario (manual mode only) -->
      <div class="card scenario-card manual-only">
        <h2>Scenario</h2>
        <div class="scenario-card-content">
          <div class="scenario-bar">
            <button class="btn-sm btn-secondary" onclick="downloadScenario()">
              Download JSON
            </button>
            <button class="btn-sm btn-secondary" onclick="document.getElementById('scenario-upload').click()">
              Upload JSON
            </button>
            <input id="scenario-upload" type="file" accept=".json" style="display: none"
              onchange="uploadScenario(this)" />
            <button class="btn-sm btn-secondary" onclick="toggleJSONEditor()">
              Edit JSON
            </button>
            <button id="btn-apply-json" class="btn-sm btn-add" onclick="applyJSONEditor()" style="display: none">
              Apply
            </button>
          </div>
          <div id="json-editor-wrap" style="display: none">
            <textarea id="scenario-json"></textarea>
          </div>
        </div>
      </div>

      <!-- Card 3 (auto mode): Auto-Tune Settings -->
      <div class="card auto-only">
        <h2>Auto-Tune Settings</h2>
        <div class="field-stack">
          <label><span>Max Rounds</span><input id="max_rounds" type="number" value="3" min="1" max="10" />
            <small class="field-desc">Number of refinement rounds. Each round narrows parameter
              bounds from the best results.</small>
          </label>
          <label><span>Values / Param</span><input id="values_per_param" type="number" value="5" min="2" max="20" />
            <small class="field-desc">Grid points sampled per parameter per round. E.g. 5 values
              across 2 params = 25 combos/round.</small>
          </label>
          <label><span>Top K</span><input id="top_k" type="number" value="5" min="1" max="50" />
            <small class="field-desc">Best results used to narrow bounds for the next round.</small>
          </label>
          <label><span>Objective</span>
            <select id="objective" onchange="toggleWeights()">
              <option value="acceptance">Acceptance Rate</option>
              <option value="weighted">Weighted (custom)</option>
              <option value="ground_truth" id="ground_truth_option" style="display: none">
                Ground Truth
              </option>
            </select>
            <small class="field-desc">Scoring function for ranking combinations. Ground Truth
              requires a scene with reference run.</small>
          </label>
        </div>
        <div id="weight-fields" style="display: none; margin-top: 10px">
          <div class="field-stack">
            <label><span>Accept Weight</span><input id="w_acceptance" type="number" step="0.1" value="1.0" />
              <small class="field-desc">Weight for acceptance rate (positive = maximise).</small>
            </label>
            <label><span>Misalign Weight</span><input id="w_misalignment" type="number" step="0.1" value="-0.5" />
              <small class="field-desc">Weight for misalignment ratio (negative = minimise).</small>
            </label>
            <label><span>Align Weight</span><input id="w_alignment" type="number" step="0.01" value="-0.01" />
              <small class="field-desc">Weight for alignment degrees (negative = minimise).</small>
            </label>
            <label><span>Cells Weight</span><input id="w_nonzero" type="number" step="0.1" value="0.1" />
              <small class="field-desc">Weight for log(nonzero cells) (positive = maximise).</small>
            </label>
          </div>
        </div>
      </div>

      <!-- Card 4: Current Tuning Parameters -->
      <div class="card">
        <h2>Current Tuning Parameters</h2>
        <div class="current-params-header">
          <small class="field-desc">Swept parameters highlighted in yellow.</small>
          <button class="refresh-params-btn" onclick="fetchCurrentParams()">
            Refresh
          </button>
        </div>
        <div id="current-params-display">Loading...</div>
      </div>
    </div>
    <!-- End other-config-section -->
  </div>
  <!-- End config-container -->

  <!-- Charts (always visible, start empty) -->
  <div id="charts-section">
    <div class="card">
      <div id="acceptance-chart" class="chart-container"></div>
    </div>
    <div class="card">
      <div id="nonzero-chart" class="chart-container"></div>
    </div>
    <div class="card">
      <div id="bucket-chart" class="chart-container"></div>
    </div>
    <div class="card">
      <div id="param-heatmap" class="chart-container"></div>
    </div>
    <div class="card">
      <div id="alignment-chart" class="chart-container"></div>
    </div>
    <div class="card">
      <div id="tracks-chart" class="chart-container"></div>
    </div>
    <div class="card">
      <div id="tracks-heatmap" class="chart-container"></div>
    </div>
    <div class="card">
      <div id="alignment-heatmap" class="chart-container"></div>
    </div>

    <!-- Results Table -->
    <div id="results-card" class="card">
      <h2>
        Results Table
        <button class="btn-sm btn-secondary" onclick="downloadCSV()" style="margin-left: 8px">
          Download CSV
        </button>
      </h2>
      <div style="overflow-x: auto">
        <table>
          <thead id="results-head">
            <tr>
              <th>Parameters</th>
              <th>Accept Rate</th>
              <th>± StdDev</th>
              <th>Nonzero Cells</th>
              <th>± StdDev</th>
              <th>Active Tracks</th>
              <th>Alignment (deg)</th>
              <th>Misalignment</th>
            </tr>
          </thead>
          <tbody id="results-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="/assets/dashboard_common.js"></script>
  <script src="/assets/sweep_dashboard.js"></script>
</body>

</html>
