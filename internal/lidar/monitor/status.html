<!DOCTYPE html>
<html>
  <head><title>Lidar Monitor - {{.SensorID}}</title></head>
  <body>
    <h1>LiDAR Monitor - {{.SensorID}}</h1>

    <h2>Configuration</h2>
    <table border="1" cellpadding="5" cellspacing="0">
      <tr>
        <td>
          <strong>Mode:</strong>
        </td>
        <td>
          <strong>{{.Mode}}</strong></td>
      </tr>
      {{if .PCAPFile}}
      <tr>
        <td>
          <strong>PCAP File:</strong>
        </td>
        <td>{{.PCAPFile}}</td>
      </tr>
      {{end}}
      <tr>
        <td>
          <strong>PCAP In Progress:</strong>
        </td>
        <td>{{.PCAPInProgress}}</td>
      </tr>
      <tr>
        <td>
          <strong>UDP Port:</strong>
        </td>
        <td>{{.UDPPort}}</td>
      </tr>
      <tr>
        <td>
          <strong>HTTP Address:</strong>
        </td>
        <td>{{.HTTPAddress}}</td>
      </tr>
      <tr>
        <td>
          <strong>Packet Forwarding:</strong>
        </td>
        <td>{{.ForwardingStatus}}</td>
      </tr>
      <tr>
        <td>
          <strong>Packet Parsing:</strong>
        </td>
        <td>{{.ParsingStatus}}</td>
      </tr>
      {{if .PCAPSafeDir}}
      <tr>
        <td>
          <strong>PCAP Safe Directory:</strong>
        </td>
        <td>{{.PCAPSafeDir}}</td>
      </tr>
      {{end}}
      <tr>
        <td>
          <strong>Uptime:</strong>
        </td>
        <td>{{.Uptime}}</td>
      </tr>
    </table>

    {{if .BGParams}}
    <h2>Background Subtraction Parameters</h2>
    <table border="1" cellpadding="5" cellspacing="0">
      <tr>
        <td>
          <strong>Noise Relative Fraction:</strong>
        </td>
        <td>{{printf "%.4f"
          .BGParams.NoiseRelativeFraction}}</td>
      </tr>
      <tr>
        <td>
          <strong>Closeness Sensitivity Multiplier:</strong>
        </td>
        <td>{{printf "%.2f"
          .BGParams.ClosenessSensitivityMultiplier}}</td>
      </tr>
      <tr>
        <td>
          <strong>Neighbor Confirmation Count:</strong>
        </td>
        <td>{{.BGParams.NeighborConfirmationCount}}</td>
      </tr>
      <tr>
        <td>
          <strong>Background Update Fraction:</strong>
        </td>
        <td>{{printf
          "%.4f" .BGParams.BackgroundUpdateFraction}}</td>
      </tr>
      <tr>
        <td>
          <strong>Safety Margin (meters):</strong>
        </td>
        <td>{{printf "%.2f"
          .BGParams.SafetyMarginMeters}}</td>
      </tr>
      <tr>
        <td>
          <strong>Seed From First Observation:</strong>
        </td>
        <td>{{.BGParams.SeedFromFirstObservation}}</td>
      </tr>
    </table>
    {{end}}

    {{if .Stats}}
    <h2>Latest Statistics</h2>
    <p><strong>Data Rate:</strong> {{printf "%.2f" .Stats.MBPerSec}} MB/sec</p>
    <p><strong>Packet Rate:</strong> {{printf "%.1f" .Stats.PacketsPerSec}}
      packets/sec</p>
    {{if .Stats.ParseEnabled}}
    <p><strong>Point Rate:</strong> {{printf "%.0f" .Stats.PointsPerSec}}
      points/sec</p>
    {{end}}
    {{if gt .Stats.DroppedCount 0}}
    <p><strong>Dropped Packets:</strong> {{.Stats.DroppedCount}} (forwarding
      backpressure)</p>
    {{end}}
    <p><strong>Last Updated:</strong> {{.Stats.Timestamp.Format "15:04:05"}}</p>
    {{else}}
    <p><em>No statistics available yet...</em></p>
    {{end}}

    <h2>API Endpoints</h2>

    <h3>System</h3>
    <ul>
      <li>
        <a href="/health">Health Check</a>
      </li>
      <li>
        <a href="/api/lidar/status?sensor_id={{.SensorID}}" target="_blank">
          LiDAR Status (JSON)
        </a>
      </li>
      <li>
        <a href="/api/lidar/data_source?sensor_id={{.SensorID}}"
          target="_blank">
          Data Source Status (live/pcap/pcap_analysis)
        </a>
      </li>
    </ul>

    <h3>Background Grid</h3>
    <ul>
      <li>
        <a href="/api/lidar/params?sensor_id={{.SensorID}}" target="_blank">
          Get/Update Background Parameters
        </a>
      </li>
      <li>
        <a href="/api/lidar/grid_status?sensor_id={{.SensorID}}"
          target="_blank">
          Grid Status
        </a>
      </li>
      <li>
        <a href="/api/lidar/grid_heatmap?sensor_id={{.SensorID}}"
          target="_blank">
          Grid Heatmap
        </a>
      </li>
      <li>
        <a href="/api/lidar/grid_reset?sensor_id={{.SensorID}}" target="_blank">
          Reset Grid
        </a>
      </li>
    </ul>

    <h3>Background Snapshots</h3>
    <ul>
      <li>
        <a href="/api/lidar/persist?sensor_id={{.SensorID}}">
          Save Background Snapshot
        </a>
      </li>
      <li>
        <a href="/api/lidar/snapshot?sensor_id={{.SensorID}}" target="_blank">
          Get Latest Snapshot
        </a>
      </li>
      <li>
        <a href="/api/lidar/snapshots?sensor_id={{.SensorID}}" target="_blank">
          List Recent Snapshots
        </a>
      </li>
      <li>
        <a href="/api/lidar/export_snapshot?sensor_id={{.SensorID}}">
          Export Latest Snapshot to ASC
        </a>
      </li>
      <li>
        <a href="/api/lidar/export_next_frame?sensor_id={{.SensorID}}">
          Export Next Completed Frame to ASC
        </a>
      </li>
    </ul>

    <h3>Acceptance Metrics</h3>
    <ul>
      <li>
        <a href="/api/lidar/acceptance?sensor_id={{.SensorID}}" target="_blank">
          Background Acceptance Metrics
        </a>
      </li>
      <li>
        <a href="/api/lidar/acceptance/reset?sensor_id={{.SensorID}}"
          target="_blank">
          Reset Acceptance Metrics
        </a>
      </li>
    </ul>

    <h3>PCAP Replay</h3>
    <ul>
      <li>
        <form action="/api/lidar/pcap/start?sensor_id={{.SensorID}}"
          method="POST"
          target="_blank"
          style="display: inline;">
          <strong>Start PCAP Replay:</strong>
          <input type="text" name="pcap_file"
            placeholder="filename.pcap" size="30"
            style="margin-left: 5px; margin-right: 5px;"
            required />
          <label style="margin-left: 5px;">
            <input type="checkbox" name="analysis_mode" value="true" />
            Analysis Mode (preserve grid)
          </label>
          <button type="submit">Run</button>
          {{if .PCAPSafeDir}}
          <span style="font-size: 0.9em; color: #666;">
            (from {{.PCAPSafeDir}})
          </span>
          {{end}}
        </form>
      </li>
      <li>
        <a href="/api/lidar/pcap/stop?sensor_id={{.SensorID}}" target="_blank">
          Stop PCAP Replay (resets grid)
        </a>
      </li>
      <li>
        <a href="/api/lidar/pcap/resume_live?sensor_id={{.SensorID}}"
          target="_blank">
          Resume Live from PCAP Analysis (preserves grid)
        </a>
      </li>
    </ul>

    <h3>Tracking</h3>
    <ul>
      <li>
        <a href="/api/lidar/tracks?sensor_id={{.SensorID}}" target="_blank">
          List All Tracks
        </a>
      </li>
      <li>
        <a href="/api/lidar/tracks/active?sensor_id={{.SensorID}}"
          target="_blank">
          Active Tracks
        </a>
      </li>
      <li>
        <a href="/api/lidar/tracks/summary?sensor_id={{.SensorID}}"
          target="_blank">
          Track Summary Statistics
        </a>
      </li>
      <li>
        <a href="/api/lidar/clusters?sensor_id={{.SensorID}}" target="_blank">
          List Clusters
        </a>
      </li>
    </ul>
  </body>
</html>
